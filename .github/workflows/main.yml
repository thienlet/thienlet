pip install python-dotenv requests

import os
import requests
import random
import time
from dotenv import load_dotenv

# Load biến môi trường từ file .env
load_dotenv()

client_id = os.getenv("CLIENT_ID")
client_secret = os.getenv("CLIENT_SECRET")
tenant_id = os.getenv("TENANT_ID")
user_email = os.getenv("USER_EMAIL")

# Step 1 - Lấy access token
def get_access_token():
    url = f"https://login.microsoftonline.com/{tenant_id}/oauth2/v2.0/token"
    data = {
        "client_id": client_id,
        "client_secret": client_secret,
        "scope": "https://graph.microsoft.com/.default",
        "grant_type": "client_credentials"
    }
    print("🔐 Đang lấy access_token...")
    resp = requests.post(url, data=data)
    if resp.status_code != 200:
        raise Exception(f"❌ Không lấy được token: {resp.text}")
    return resp.json()["access_token"]

token = get_access_token()
headers = {
    "Authorization": f"Bearer {token}",
    "Content-Type": "application/json"
}

# Step 2 - Gửi mail
def send_mail():
    recipients = [
        "tlee@thienbh.onmicrosoft.com", "trunglk@thienbh.onmicrosoft.com",
        "loan11@thienbh.onmicrosoft.com", "glxa25@thienbh.onmicrosoft.com"
    ]
    mail_payload = {
        "message": {
            "subject": "Mail khen thưởng nội bộ và ngoài hệ thống",
            "body": {
                "contentType": "Text",
                "content": (
                    "Chào buổi sáng cả nhà,\n\n"
                    "Hy vọng mọi người có một khởi đầu ngày mới thật nhiều năng lượng!\n\n"
                    "Tôi muốn dành vài phút để gửi lời khen thưởng đặc biệt đến toàn thể đội ngũ..."
                    "\n\nTrân trọng,"
                )
            },
            "toRecipients": [{"emailAddress": {"address": email}} for email in recipients]
        }
    }
    print("📬 Đang gửi mail...")
    res = requests.post(
        f"https://graph.microsoft.com/v1.0/users/{user_email}/sendMail",
        headers=headers,
        json=mail_payload
    )
    print("📤 Trạng thái gửi mail:", res.status_code, res.text)

# Step 3 - Ping API
def safe_get(url, label):
    try:
        res = requests.get(url, headers=headers)
        print(f"{label} → Status:", res.status_code)
        return res
    except Exception as e:
        print(f"{label} → Lỗi:", e)

def ping_graph_services():
    safe_get(f"https://graph.microsoft.com/v1.0/users/{user_email}", "👤 User info")
    safe_get(f"https://graph.microsoft.com/v1.0/users/{user_email}/drive", "📁 OneDrive")
    safe_get(f"https://graph.microsoft.com/v1.0/users/{user_email}/mailFolders", "📨 MailFolders")
    safe_get(f"https://graph.microsoft.com/v1.0/users/{user_email}/joinedTeams", "💬 Teams")
    safe_get(f"https://graph.microsoft.com/v1.0/users/{user_email}/calendars", "📅 Calendar")

# Step 4 - Upload file giả lên OneDrive
def upload_fake_files(folder="Anh_code77"):
    for i in range(random.randint(3, 4)):
        filename = f"note_{random.randint(1000,9999)}.txt"
        content = f"Đây là file giả số {i+1} để giữ OneDrive hoạt động."
        url = f"https://graph.microsoft.com/v1.0/users/{user_email}/drive/root:/{folder}/{filename}:/content"
        res = requests.put(url, headers=headers, data=content.encode("utf-8"))
        print(f"📎 Upload {filename} → Status:", res.status_code)

# Step 5 - Upload ảnh bằng rclone
def rclone_upload(local_folder, remote_path):
    print(f"📤 Đang upload ảnh từ {local_folder} lên {remote_path}...")
    os.system(f'rclone copy "{local_folder}" "{remote_path}" --transfers=4 --checkers=8 --fast-list')

# Step 6 - Xác nhận xoá thư mục bằng rclone
def rclone_delete(remote_path):
    confirm = input(f"⚠️ Bạn có chắc chắn muốn XOÁ TOÀN BỘ dữ liệu trong {remote_path}? (yes/no): ")
    if confirm.lower() == "yes":
        print("🧹 Đang xoá dữ liệu...")
        os.system(f"rclone delete {remote_path}")
    else:
        print("❎ Huỷ thao tác xoá.")

# Chạy toàn bộ
if __name__ == "__main__":
    send_mail()
    ping_graph_services()
    rclone_delete("onedrive_remote:Anh_code77")  # Thay bằng tên đúng
    upload_fake_files("Anh_code77")
    rclone_upload("D:\\LG_TP3", "onedrive_remote:Anh_code77")  # Thay đúng remote + thư mục
