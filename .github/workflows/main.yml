pip install python-dotenv requests

import os
import requests
import random
import time
from dotenv import load_dotenv

# Load biáº¿n mÃ´i trÆ°á»ng tá»« file .env
load_dotenv()

client_id = os.getenv("CLIENT_ID")
client_secret = os.getenv("CLIENT_SECRET")
tenant_id = os.getenv("TENANT_ID")
user_email = os.getenv("USER_EMAIL")

# Step 1 - Láº¥y access token
def get_access_token():
    url = f"https://login.microsoftonline.com/{tenant_id}/oauth2/v2.0/token"
    data = {
        "client_id": client_id,
        "client_secret": client_secret,
        "scope": "https://graph.microsoft.com/.default",
        "grant_type": "client_credentials"
    }
    print("ğŸ” Äang láº¥y access_token...")
    resp = requests.post(url, data=data)
    if resp.status_code != 200:
        raise Exception(f"âŒ KhÃ´ng láº¥y Ä‘Æ°á»£c token: {resp.text}")
    return resp.json()["access_token"]

token = get_access_token()
headers = {
    "Authorization": f"Bearer {token}",
    "Content-Type": "application/json"
}

# Step 2 - Gá»­i mail
def send_mail():
    recipients = [
        "tlee@thienbh.onmicrosoft.com", "trunglk@thienbh.onmicrosoft.com",
        "loan11@thienbh.onmicrosoft.com", "glxa25@thienbh.onmicrosoft.com"
    ]
    mail_payload = {
        "message": {
            "subject": "Mail khen thÆ°á»Ÿng ná»™i bá»™ vÃ  ngoÃ i há»‡ thá»‘ng",
            "body": {
                "contentType": "Text",
                "content": (
                    "ChÃ o buá»•i sÃ¡ng cáº£ nhÃ ,\n\n"
                    "Hy vá»ng má»i ngÆ°á»i cÃ³ má»™t khá»Ÿi Ä‘áº§u ngÃ y má»›i tháº­t nhiá»u nÄƒng lÆ°á»£ng!\n\n"
                    "TÃ´i muá»‘n dÃ nh vÃ i phÃºt Ä‘á»ƒ gá»­i lá»i khen thÆ°á»Ÿng Ä‘áº·c biá»‡t Ä‘áº¿n toÃ n thá»ƒ Ä‘á»™i ngÅ©..."
                    "\n\nTrÃ¢n trá»ng,"
                )
            },
            "toRecipients": [{"emailAddress": {"address": email}} for email in recipients]
        }
    }
    print("ğŸ“¬ Äang gá»­i mail...")
    res = requests.post(
        f"https://graph.microsoft.com/v1.0/users/{user_email}/sendMail",
        headers=headers,
        json=mail_payload
    )
    print("ğŸ“¤ Tráº¡ng thÃ¡i gá»­i mail:", res.status_code, res.text)

# Step 3 - Ping API
def safe_get(url, label):
    try:
        res = requests.get(url, headers=headers)
        print(f"{label} â†’ Status:", res.status_code)
        return res
    except Exception as e:
        print(f"{label} â†’ Lá»—i:", e)

def ping_graph_services():
    safe_get(f"https://graph.microsoft.com/v1.0/users/{user_email}", "ğŸ‘¤ User info")
    safe_get(f"https://graph.microsoft.com/v1.0/users/{user_email}/drive", "ğŸ“ OneDrive")
    safe_get(f"https://graph.microsoft.com/v1.0/users/{user_email}/mailFolders", "ğŸ“¨ MailFolders")
    safe_get(f"https://graph.microsoft.com/v1.0/users/{user_email}/joinedTeams", "ğŸ’¬ Teams")
    safe_get(f"https://graph.microsoft.com/v1.0/users/{user_email}/calendars", "ğŸ“… Calendar")

# Step 4 - Upload file giáº£ lÃªn OneDrive
def upload_fake_files(folder="Anh_code77"):
    for i in range(random.randint(3, 4)):
        filename = f"note_{random.randint(1000,9999)}.txt"
        content = f"ÄÃ¢y lÃ  file giáº£ sá»‘ {i+1} Ä‘á»ƒ giá»¯ OneDrive hoáº¡t Ä‘á»™ng."
        url = f"https://graph.microsoft.com/v1.0/users/{user_email}/drive/root:/{folder}/{filename}:/content"
        res = requests.put(url, headers=headers, data=content.encode("utf-8"))
        print(f"ğŸ“ Upload {filename} â†’ Status:", res.status_code)

# Step 5 - Upload áº£nh báº±ng rclone
def rclone_upload(local_folder, remote_path):
    print(f"ğŸ“¤ Äang upload áº£nh tá»« {local_folder} lÃªn {remote_path}...")
    os.system(f'rclone copy "{local_folder}" "{remote_path}" --transfers=4 --checkers=8 --fast-list')

# Step 6 - XÃ¡c nháº­n xoÃ¡ thÆ° má»¥c báº±ng rclone
def rclone_delete(remote_path):
    confirm = input(f"âš ï¸ Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n XOÃ TOÃ€N Bá»˜ dá»¯ liá»‡u trong {remote_path}? (yes/no): ")
    if confirm.lower() == "yes":
        print("ğŸ§¹ Äang xoÃ¡ dá»¯ liá»‡u...")
        os.system(f"rclone delete {remote_path}")
    else:
        print("â Huá»· thao tÃ¡c xoÃ¡.")

# Cháº¡y toÃ n bá»™
if __name__ == "__main__":
    send_mail()
    ping_graph_services()
    rclone_delete("onedrive_remote:Anh_code77")  # Thay báº±ng tÃªn Ä‘Ãºng
    upload_fake_files("Anh_code77")
    rclone_upload("D:\\LG_TP3", "onedrive_remote:Anh_code77")  # Thay Ä‘Ãºng remote + thÆ° má»¥c
